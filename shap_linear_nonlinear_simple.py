import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import shap
import joblib
from sklearn.preprocessing import StandardScaler
import warnings
warnings.filterwarnings('ignore')

# Set style for better visualization
plt.style.use('seaborn-v0_8')
sns.set_palette("husl")

print("="*80)
print("üîç SHAP PH√ÇN T√çCH TUY·∫æN T√çNH vs PHI TUY·∫æN - M√î H√åNH XGBOOST")
print("="*80)

# Load the trained model and scaler
print("üì• ƒêang t·∫£i m√¥ h√¨nh XGBoost ƒë√£ hu·∫•n luy·ªán...")
try:
    model = joblib.load('best_model_xgboost.pkl')
    scaler = joblib.load('scaler.pkl')
    print("‚úÖ ƒê√£ t·∫£i th√†nh c√¥ng m√¥ h√¨nh v√† scaler")
except FileNotFoundError:
    print("‚ùå Kh√¥ng t√¨m th·∫•y file m√¥ h√¨nh. Vui l√≤ng ch·∫°y fast_model_comparison.py tr∆∞·ªõc.")
    exit()

# Load processed data
print("üì• ƒêang t·∫£i d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω...")
try:
    df = pd.read_csv('processed_data.csv')
    print(f"‚úÖ ƒê√£ t·∫£i {len(df):,} b·∫£n ghi")
except FileNotFoundError:
    print("‚ùå Kh√¥ng t√¨m th·∫•y file processed_data.csv. Vui l√≤ng ch·∫°y analyze_dataset.py tr∆∞·ªõc.")
    exit()

# Sample data for SHAP analysis (faster computation)
print("üîÑ L·∫•y m·∫´u d·ªØ li·ªáu cho ph√¢n t√≠ch SHAP...")
df_sample = df.sample(n=min(5000, len(df)), random_state=42)

# Prepare features - use only the features that were used during training
feature_columns = [
    'price', 'total_purchases', 'total_events', 'purchase_rate', 'avg_price', 'price_std', 
    'min_price', 'max_price', 'unique_products', 'unique_categories', 
    'session_duration_days', 'product_purchases', 'product_views', 'product_purchase_rate', 
    'product_price', 'unique_users', 'category_purchases', 'category_views', 
    'category_purchase_rate', 'category_price', 'category_users', 'price_ratio', 
    'is_expensive', 'price_category_encoded'
]

# Filter to only include features that exist in the dataset
feature_columns = [col for col in feature_columns if col in df_sample.columns]

X_sample = df_sample[feature_columns]
y_sample = df_sample['purchased']

# Scale features
X_sample_scaled = scaler.transform(X_sample)

print(f"üìä Ph√¢n t√≠ch tr√™n {len(X_sample):,} m·∫´u v·ªõi {len(feature_columns)} features")

# Create SHAP explainer
print("üîß ƒêang t·∫°o SHAP explainer...")
explainer = shap.TreeExplainer(model)
shap_values = explainer.shap_values(X_sample_scaled)

print("‚úÖ ƒê√£ t√≠nh to√°n SHAP values th√†nh c√¥ng")

# Define linear and non-linear features based on domain knowledge
linear_features = [
    'total_purchases', 'purchase_rate', 'product_purchases', 
    'category_purchases', 'total_events', 'product_views'
]

nonlinear_features = [
    'price_ratio', 'session_duration_days', 'avg_session_duration',
    'unique_categories', 'category_views', 'is_expensive', 'price'
]

# Ensure all features exist in the dataset
linear_features = [f for f in linear_features if f in feature_columns]
nonlinear_features = [f for f in nonlinear_features if f in feature_columns]

print(f"üìà Features tuy·∫øn t√≠nh: {len(linear_features)}")
print(f"üìä Features phi tuy·∫øn: {len(nonlinear_features)}")

# Create comprehensive visualization
fig = plt.figure(figsize=(20, 12))
gs = fig.add_gridspec(2, 3, hspace=0.4, wspace=0.3)

# 1. Feature Importance Comparison
ax1 = fig.add_subplot(gs[0, :])
feature_importance = np.abs(shap_values).mean(0)
feature_importance_df = pd.DataFrame({
    'feature': feature_columns,
    'importance': feature_importance
}).sort_values('importance', ascending=True)

# Color by linear/non-linear
colors = []
for feature in feature_importance_df['feature']:
    if feature in linear_features:
        colors.append('lightblue')
    elif feature in nonlinear_features:
        colors.append('lightcoral')
    else:
        colors.append('lightgray')

bars = ax1.barh(range(len(feature_importance_df)), feature_importance_df['importance'], 
                color=colors, alpha=0.8, edgecolor='black', linewidth=0.5)
ax1.set_yticks(range(len(feature_importance_df)))
ax1.set_yticklabels(feature_importance_df['feature'], fontsize=10)
ax1.set_xlabel('Mean |SHAP Value|', fontsize=12, fontweight='bold')
ax1.set_title('Feature Importance - Ph√¢n lo·∫°i Tuy·∫øn/Phi tuy·∫øn', fontsize=16, fontweight='bold', pad=20)

# Add legend
from matplotlib.patches import Patch
legend_elements = [Patch(facecolor='lightblue', label='Tuy·∫øn t√≠nh'),
                  Patch(facecolor='lightcoral', label='Phi tuy·∫øn'),
                  Patch(facecolor='lightgray', label='Kh√°c')]
ax1.legend(handles=legend_elements, loc='lower right')

# 2. Linear vs Non-linear Impact Analysis
ax2 = fig.add_subplot(gs[1, 0])
linear_indices = [feature_columns.index(f) for f in linear_features if f in feature_columns]
nonlinear_indices = [feature_columns.index(f) for f in nonlinear_features if f in feature_columns]

linear_impact = np.abs(shap_values[:, linear_indices]).mean() if linear_indices else 0
nonlinear_impact = np.abs(shap_values[:, nonlinear_indices]).mean() if nonlinear_indices else 0

categories = ['Tuy·∫øn t√≠nh', 'Phi tuy·∫øn']
impacts = [linear_impact, nonlinear_impact]
colors = ['lightblue', 'lightcoral']

bars = ax2.bar(categories, impacts, color=colors, alpha=0.8, edgecolor='black', linewidth=2)
ax2.set_ylabel('Mean |SHAP Value|', fontsize=12, fontweight='bold')
ax2.set_title('T√°c ƒë·ªông T·ªïng th·ªÉ', fontsize=14, fontweight='bold', pad=20)

# Add value labels on bars
for bar, impact in zip(bars, impacts):
    height = bar.get_height()
    ax2.text(bar.get_x() + bar.get_width()/2., height + 0.001,
             f'{impact:.4f}', ha='center', va='bottom', fontweight='bold', fontsize=12)

# 3. Top Linear Features
ax3 = fig.add_subplot(gs[1, 1])
if linear_indices:
    linear_importance = np.abs(shap_values[:, linear_indices]).mean(0)
    linear_df = pd.DataFrame({
        'feature': linear_features,
        'importance': linear_importance
    }).sort_values('importance', ascending=True)
    
    bars = ax3.barh(range(len(linear_df)), linear_df['importance'], 
                    color='lightblue', alpha=0.8, edgecolor='black', linewidth=0.5)
    ax3.set_yticks(range(len(linear_df)))
    ax3.set_yticklabels(linear_df['feature'], fontsize=10)
    ax3.set_xlabel('Mean |SHAP Value|', fontsize=12, fontweight='bold')
    ax3.set_title('Top Features Tuy·∫øn t√≠nh', fontsize=14, fontweight='bold', pad=20)

# 4. Top Non-linear Features
ax4 = fig.add_subplot(gs[1, 2])
if nonlinear_indices:
    nonlinear_importance = np.abs(shap_values[:, nonlinear_indices]).mean(0)
    nonlinear_df = pd.DataFrame({
        'feature': nonlinear_features,
        'importance': nonlinear_importance
    }).sort_values('importance', ascending=True)
    
    bars = ax4.barh(range(len(nonlinear_df)), nonlinear_df['importance'], 
                    color='lightcoral', alpha=0.8, edgecolor='black', linewidth=0.5)
    ax4.set_yticks(range(len(nonlinear_df)))
    ax4.set_yticklabels(nonlinear_df['feature'], fontsize=10)
    ax4.set_xlabel('Mean |SHAP Value|', fontsize=12, fontweight='bold')
    ax4.set_title('Top Features Phi tuy·∫øn', fontsize=14, fontweight='bold', pad=20)

plt.tight_layout()
plt.savefig('shap_linear_nonlinear_analysis.png', dpi=300, bbox_inches='tight')
print("‚úÖ ƒê√£ l∆∞u bi·ªÉu ƒë·ªì SHAP ph√¢n t√≠ch: shap_linear_nonlinear_analysis.png")

# Generate detailed analysis report
print("\n" + "="*80)
print("üìä PH√ÇN T√çCH CHI TI·∫æT TUY·∫æN T√çNH vs PHI TUY·∫æN")
print("="*80)

print(f"\nüîç T·ªîNG QUAN:")
print(f"   ‚Ä¢ T·ªïng s·ªë features: {len(feature_columns)}")
print(f"   ‚Ä¢ Features tuy·∫øn t√≠nh: {len(linear_features)}")
print(f"   ‚Ä¢ Features phi tuy·∫øn: {len(nonlinear_features)}")
print(f"   ‚Ä¢ M·∫´u ph√¢n t√≠ch: {len(X_sample):,} records")

if linear_indices:
    linear_avg_impact = np.abs(shap_values[:, linear_indices]).mean()
    print(f"\nüìà FEATURES TUY·∫æN T√çNH:")
    print(f"   ‚Ä¢ T√°c ƒë·ªông trung b√¨nh: {linear_avg_impact:.4f}")
    print(f"   ‚Ä¢ C√°c features ch√≠nh:")
    linear_importance = np.abs(shap_values[:, linear_indices]).mean(0)
    linear_df = pd.DataFrame({
        'feature': linear_features,
        'importance': linear_importance
    }).sort_values('importance', ascending=False)
    
    for i, (_, row) in enumerate(linear_df.head(5).iterrows(), 1):
        print(f"      {i}. {row['feature']}: {row['importance']:.4f}")

if nonlinear_indices:
    nonlinear_avg_impact = np.abs(shap_values[:, nonlinear_indices]).mean()
    print(f"\nüìä FEATURES PHI TUY·∫æN:")
    print(f"   ‚Ä¢ T√°c ƒë·ªông trung b√¨nh: {nonlinear_avg_impact:.4f}")
    print(f"   ‚Ä¢ C√°c features ch√≠nh:")
    nonlinear_importance = np.abs(shap_values[:, nonlinear_indices]).mean(0)
    nonlinear_df = pd.DataFrame({
        'feature': nonlinear_features,
        'importance': nonlinear_importance
    }).sort_values('importance', ascending=False)
    
    for i, (_, row) in enumerate(nonlinear_df.head(5).iterrows(), 1):
        print(f"      {i}. {row['feature']}: {row['importance']:.4f}")

print(f"\nüí° K·∫æT LU·∫¨N:")
if linear_indices and nonlinear_indices:
    if linear_avg_impact > nonlinear_avg_impact:
        print(f"   ‚Ä¢ Features tuy·∫øn t√≠nh c√≥ t√°c ƒë·ªông l·ªõn h∆°n ({linear_avg_impact:.4f} vs {nonlinear_avg_impact:.4f})")
        print(f"   ‚Ä¢ M√¥ h√¨nh XGBoost t·∫≠n d·ª•ng t·ªët m·ªëi quan h·ªá tuy·∫øn t√≠nh")
    else:
        print(f"   ‚Ä¢ Features phi tuy·∫øn c√≥ t√°c ƒë·ªông l·ªõn h∆°n ({nonlinear_avg_impact:.4f} vs {linear_avg_impact:.4f})")
        print(f"   ‚Ä¢ M√¥ h√¨nh XGBoost t·∫≠n d·ª•ng t·ªët m·ªëi quan h·ªá phi tuy·∫øn")
    
    print(f"   ‚Ä¢ XGBoost c√¢n b·∫±ng t·ªët gi·ªØa c·∫£ hai lo·∫°i m·ªëi quan h·ªá")
    print(f"   ‚Ä¢ ƒêi·ªÅu n√†y gi·∫£i th√≠ch t·∫°i sao XGBoost v∆∞·ª£t tr·ªôi h∆°n c√°c m√¥ h√¨nh tuy·∫øn t√≠nh")

print(f"\nüéØ √ù NGHƒ®A TH·ª∞C TI·ªÑN:")
print(f"   ‚Ä¢ M√¥ h√¨nh c√≥ th·ªÉ h·ªçc ƒë∆∞·ª£c c·∫£ patterns ƒë∆°n gi·∫£n (tuy·∫øn t√≠nh) v√† ph·ª©c t·∫°p (phi tuy·∫øn)")
print(f"   ‚Ä¢ Ph√π h·ª£p v·ªõi b·∫£n ch·∫•t ƒëa d·∫°ng c·ªßa h√†nh vi ng∆∞·ªùi d√πng e-commerce")
print(f"   ‚Ä¢ Gi·∫£i th√≠ch ƒë∆∞·ª£c c·∫£ m·ªëi quan h·ªá tr·ª±c ti·∫øp v√† gi√°n ti·∫øp trong d·ªØ li·ªáu")

# Create SHAP summary plots separately
print("\nüìä ƒêang t·∫°o SHAP Summary Plots ri√™ng bi·ªát...")

# SHAP Summary Plot - All Features
plt.figure(figsize=(12, 8))
shap.summary_plot(shap_values, X_sample_scaled, feature_names=feature_columns, 
                  max_display=15, show=False)
plt.title('SHAP Summary Plot - T·∫•t c·∫£ Features', fontsize=16, fontweight='bold', pad=20)
plt.tight_layout()
plt.savefig('shap_summary_all_features.png', dpi=300, bbox_inches='tight')
print("‚úÖ ƒê√£ l∆∞u: shap_summary_all_features.png")

# SHAP Summary Plot - Linear Features Only
if linear_indices:
    plt.figure(figsize=(10, 6))
    shap.summary_plot(shap_values[:, linear_indices], X_sample_scaled[:, linear_indices], 
                      feature_names=linear_features, max_display=len(linear_features), 
                      show=False)
    plt.title('SHAP Summary - Features Tuy·∫øn t√≠nh', fontsize=16, fontweight='bold', pad=20)
    plt.tight_layout()
    plt.savefig('shap_summary_linear_features.png', dpi=300, bbox_inches='tight')
    print("‚úÖ ƒê√£ l∆∞u: shap_summary_linear_features.png")

# SHAP Summary Plot - Non-linear Features Only
if nonlinear_indices:
    plt.figure(figsize=(10, 6))
    shap.summary_plot(shap_values[:, nonlinear_indices], X_sample_scaled[:, nonlinear_indices], 
                      feature_names=nonlinear_features, max_display=len(nonlinear_features), 
                      show=False)
    plt.title('SHAP Summary - Features Phi Tuy·∫øn', fontsize=16, fontweight='bold', pad=20)
    plt.tight_layout()
    plt.savefig('shap_summary_nonlinear_features.png', dpi=300, bbox_inches='tight')
    print("‚úÖ ƒê√£ l∆∞u: shap_summary_nonlinear_features.png")

print(f"\nüìÅ FILES ƒê√É T·∫†O:")
print(f"   ‚Ä¢ shap_linear_nonlinear_analysis.png - Bi·ªÉu ƒë·ªì ph√¢n t√≠ch t·ªïng h·ª£p")
print(f"   ‚Ä¢ shap_summary_all_features.png - SHAP summary t·∫•t c·∫£ features")
print(f"   ‚Ä¢ shap_summary_linear_features.png - SHAP summary features tuy·∫øn t√≠nh")
print(f"   ‚Ä¢ shap_summary_nonlinear_features.png - SHAP summary features phi tuy·∫øn")
print(f"   ‚Ä¢ B√°o c√°o chi ti·∫øt trong console")

print("\nüéä PH√ÇN T√çCH SHAP HO√ÄN TH√ÄNH!")
print("="*80)